<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temporizador Pomodoro Inteligente</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        :root {
            --color-accent: #0ea5e9;
            --color-accent-hover: #0284c7;
        }
        #time-input-edit::-webkit-outer-spin-button,
        #time-input-edit::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #time-input-edit { -moz-appearance: textfield; }
        .active-mode { background-color: var(--color-accent) !important; color: white; font-weight: 700; }
        .dark .active-mode { color: #0f172a; }
        .history-tab.active, .achievements-tab.active { border-color: var(--color-accent); color: var(--color-accent); }
        .ambient-btn.active { background-color: var(--color-accent); color: white; }
        .dark .ambient-btn.active { color: #0f172a; }
        #volume-slider { -webkit-appearance: none; appearance: none; width: 100px; height: 8px; background: #d3d3d3; outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 4px; }
        #volume-slider:hover { opacity: 1; }
        #volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--color-accent); cursor: pointer; border-radius: 50%; }
        #volume-slider::-moz-range-thumb { width: 16px; height: 16px; background: var(--color-accent); cursor: pointer; border-radius: 50%; }
        #plant-container svg { transition: all 0.5s ease-in-out; }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        #voice-control-button.listening svg { color: var(--color-accent); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .toast-notification {
            animation: slideInUp 0.5s ease-out forwards, fadeOutToast 0.5s ease-in 4.5s forwards;
        }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; } }
        
        .owl-anim-body { animation: owl-bob 7s ease-in-out infinite; }
        .owl-anim-eyes { transform-origin: center; animation: owl-blink 5s linear infinite 1s; }
        @keyframes owl-bob { 0%, 100% { transform: translateY(0) rotate(-1deg); } 50% { transform: translateY(3px) rotate(1deg); } }
        @keyframes owl-blink { 0%, 95%, 100% { transform: scaleY(1); } 97.5% { transform: scaleY(0.05); } }
        
        .task-item.active { background-color: var(--color-accent); color: white; }
        .task-item.active .task-text { text-decoration: none; }

        .friend-status-paused .status-indicator { background-color: #f59e0b; }
        .friend-status-pomodoro .status-indicator { background-color: #10b981; }
        .friend-status-shortBreak .status-indicator, .friend-status-longBreak .status-indicator { background-color: #3b82f6; }
        .friend-progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="text-slate-800 dark:text-white flex items-center justify-center min-h-screen p-4 transition-colors duration-300">

<div id="main-container" class="w-full max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 lg:gap-8 items-start">
    <div id="main-card" class="w-full max-w-lg mx-auto rounded-2xl shadow-2xl p-6 md:p-8 relative transition-colors duration-300 lg:col-start-2">
        
        <div class="absolute top-5 left-5 flex items-center space-x-2">
            <div id="main-menu-wrapper" class="relative">
                <button id="menu-button" class="p-2 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div id="main-menu" class="absolute top-12 left-0 bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm p-2 rounded-lg shadow-lg hidden w-52 z-20">
                    <button id="trajectory-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Trayectoria</button>
                    <button id="friends-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Amigos</button>
                    <button id="achievements-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Medallas</button>
                    <button id="forest-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Bosque</button>
                    <button id="history-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Historial</button>
                    <button id="suggestions-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Sugerencias</button>
                    <button id="share-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Compartir</button>
                    <div class="border-t border-slate-300 dark:border-slate-700 my-1"></div>
                    <button id="notifications-button" class="w-full text-left px-4 py-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">Activar Notificaciones</button>
                </div>
            </div>
            <div id="volume-control-wrapper" class="relative">
                <button id="volume-button" class="p-2 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                </button>
                <div id="volume-slider-container" class="absolute top-12 left-0 bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm p-4 rounded-lg shadow-lg hidden z-20 w-48">
                    <p class="text-xs font-bold mb-2">Notificaci√≥n</p>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" class="w-full">
                    <p class="text-xs font-bold mt-4 mb-2">Sonido Ambiente</p>
                    <div id="ambient-sounds-controls" class="flex justify-around bg-slate-200/70 dark:bg-slate-700/70 p-1 rounded-lg">
                        <button data-sound="off" class="ambient-btn w-full p-1 rounded-md text-sm transition-colors active">Off</button>
                        <button data-sound="rain" class="ambient-btn w-full p-1 rounded-md text-sm transition-colors">Lluvia</button>
                        <button data-sound="noise" class="ambient-btn w-full p-1 rounded-md text-sm transition-colors">Ruido</button>
                    </div>
                </div>
            </div>
            <div id="voice-control-wrapper" class="relative">
                <button id="voice-control-button" class="p-2 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors" title="Control por voz (experimental)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                </button>
            </div>
        </div>

        <div class="absolute top-5 right-5 flex items-center space-x-2">
            <button id="dark-mode-toggle" class="p-2 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors">
                <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
            <div id="theme-button-wrapper" class="relative">
                <button id="theme-button" class="p-2 rounded-full hover:bg-slate-200/50 dark:hover:bg-slate-700/50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                </button>
                <div id="color-palette" class="absolute top-12 right-0 bg-white/70 dark:bg-slate-900/70 backdrop-blur-sm p-2 rounded-lg shadow-lg hidden flex space-x-2 z-20">
                    <button data-theme="cyan" class="w-8 h-8 rounded-full bg-cyan-500 border-4 border-transparent"></button>
                    <button data-theme="rose" class="w-8 h-8 rounded-full bg-rose-500 border-4 border-transparent"></button>
                    <button data-theme="emerald" class="w-8 h-8 rounded-full bg-emerald-500 border-4 border-transparent"></button>
                    <button data-theme="violet" class="w-8 h-8 rounded-full bg-violet-500 border-4 border-transparent"></button>
                    <button data-theme="amber" class="w-8 h-8 rounded-full bg-amber-500 border-4 border-transparent"></button>
                </div>
            </div>
        </div>

        <div id="mode-selector-wrapper" class="text-center pt-8 mt-8">
            <div id="mode-selector" class="flex justify-center space-x-2 mb-4 bg-slate-200/70 dark:bg-slate-700/70 p-1 rounded-lg">
                <button data-mode="pomodoro" class="mode-select-btn w-full px-4 py-2 rounded-md text-sm font-medium transition-colors">Trabajo</button>
                <button data-mode="shortBreak" class="mode-select-btn w-full px-4 py-2 rounded-md text-sm font-medium transition-colors">Descanso C.</button>
                <button data-mode="longBreak" class="mode-select-btn w-full px-4 py-2 rounded-md text-sm font-medium transition-colors">Descanso L.</button>
            </div>
        </div>

        <div class="relative w-64 h-64 md:w-72 md:h-72 mx-auto my-2 flex items-center justify-center">
            <svg class="absolute top-0 left-0 w-full h-full" viewBox="0 0 100 100"><circle class="text-slate-200 dark:text-slate-700/50" stroke-width="7" cx="50" cy="50" r="45" fill="transparent"></circle><circle id="progress-ring" class="transition-all duration-500" stroke="var(--color-accent)" stroke-width="7" cx="50" cy="50" r="45" fill="transparent" stroke-linecap="round" transform="rotate(-90 50 50)" stroke-dasharray="283" stroke-dashoffset="283"></circle></svg>
            <div id="time-display-wrapper" class="flex items-center justify-center"><div id="time-display" class="text-6xl md:text-7xl font-extrabold z-10 text-[--color-accent] transition-colors duration-300 cursor-pointer hover:opacity-80">25:00</div></div>
        </div>
        
        <div class="flex justify-center space-x-4 my-6"><button id="start-pause-button" class="bg-[--color-accent] hover:bg-[--color-accent-hover] text-white dark:text-slate-900 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 transition-colors duration-300">Empezar</button><button id="reset-button" class="bg-slate-200/70 hover:bg-slate-300/70 dark:bg-slate-700/70 dark:hover:bg-slate-600/70 text-slate-700 dark:text-slate-300 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 transition-colors duration-300">Resetear</button></div>

        <div id="ai-suggestion-box" class="bg-slate-100/50 dark:bg-slate-700/50 border border-slate-300/50 dark:border-slate-600/50 rounded-lg p-4 text-center min-h-[90px] flex items-center justify-center transition opacity-0"><p id="ai-suggestion-text" class="text-slate-600 dark:text-slate-300 italic">Aqu√≠ aparecer√° una sugerencia inteligente para tu descanso.</p></div>
    </div>

    <div id="stats-card" class="w-full max-w-lg mx-auto rounded-2xl shadow-2xl p-6 md:p-8 transition-colors duration-300 mt-8 lg:mt-0 lg:col-start-1 lg:row-start-1">
        <h2 class="text-2xl font-bold text-center mb-4">Estad√≠sticas del D√≠a</h2>
        <div class="text-center mb-4">
            <span id="xp-level" class="font-bold text-lg text-[--color-accent]">Nivel 1</span>
            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mt-1">
                <div id="xp-bar" class="bg-[--color-accent] h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <span id="xp-text" class="text-xs text-slate-500 dark:text-slate-400">0 / 100 XP</span>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-4 text-center border-t border-slate-200 dark:border-slate-700 pt-4">
            <div><p class="text-sm text-slate-500 dark:text-slate-400">Trabajo</p><p id="stats-work-time" class="text-xl font-bold text-[--color-accent]">0 min</p></div>
            <div><p class="text-sm text-slate-500 dark:text-slate-400">Descanso</p><p id="stats-break-time" class="text-xl font-bold text-[--color-accent]">0 min</p></div>
            <div><p class="text-sm text-slate-500 dark:text-slate-400">Ciclos</p><p id="stats-cycles" class="text-xl font-bold text-[--color-accent]">0</p></div>
        </div>
        <div><canvas id="stats-chart"></canvas></div>
    </div>
    
    <div class="w-full max-w-lg mx-auto lg:col-start-3 lg:row-start-1 space-y-8 mt-8 lg:mt-0">
        <div id="plant-card" class="rounded-2xl shadow-2xl p-6 md:p-8 transition-colors duration-300">
            <h2 class="text-2xl font-bold text-center mb-6">Mi Planta Virtual</h2>
            <div id="plant-container" class="flex justify-center items-center h-full min-h-[280px]"></div>
        </div>

        <div id="tasks-card" class="rounded-2xl shadow-2xl p-6 md:p-8 transition-colors duration-300">
            <h2 class="text-2xl font-bold text-center mb-4">Lista de Tareas</h2>
            <div id="task-list-wrapper">
                <form id="add-task-form" class="flex space-x-2 mb-2">
                    <input type="text" id="task-input" placeholder="Nueva tarea..." class="w-full bg-slate-100/50 dark:bg-slate-700/50 border-2 border-slate-300/50 dark:border-slate-600/50 rounded-lg px-4 py-2 text-center focus:outline-none transition-colors duration-300 focus:border-[--color-accent] focus:ring-1 focus:ring-[--color-accent]">
                    <button type="submit" class="bg-[--color-accent] hover:bg-[--color-accent-hover] text-white dark:text-slate-900 font-bold py-2 px-4 rounded-lg">+</button>
                    <button type="button" id="breakdown-task-btn" title="‚ú® Desglosar tarea con IA" class="bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">‚ú®</button>
                </form>
                <div id="task-list-container" class="max-h-40 overflow-y-auto pr-2">
                    <ul id="task-list"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast-container" class="fixed bottom-5 right-5 z-[100] w-full max-w-xs space-y-3"></div>

<!-- Modals -->
<div id="history-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>
<div id="suggestions-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>
<div id="achievements-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>
<div id="forest-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>
<div id="trajectory-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>
<div id="share-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>
<div id="friends-modal" class="fixed inset-0 bg-slate-100/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 sm:p-6 lg:p-8 z-50 hidden overflow-y-auto"></div>


<script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const DOM = {
        timeDisplay: document.getElementById('time-display'),
        timeDisplayWrapper: document.getElementById('time-display-wrapper'),
        startPauseButton: document.getElementById('start-pause-button'),
        resetButton: document.getElementById('reset-button'),
        aiSuggestionBox: document.getElementById('ai-suggestion-box'),
        aiSuggestionText: document.getElementById('ai-suggestion-text'),
        progressRing: document.getElementById('progress-ring'),
        menuButton: document.getElementById('menu-button'),
        mainMenu: document.getElementById('main-menu'),
        volumeButton: document.getElementById('volume-button'),
        volumeSliderContainer: document.getElementById('volume-slider-container'),
        volumeSlider: document.getElementById('volume-slider'),
        voiceControlButton: document.getElementById('voice-control-button'),
        historyButton: document.getElementById('history-button'),
        historyModal: document.getElementById('history-modal'),
        suggestionsButton: document.getElementById('suggestions-button'),
        suggestionsModal: document.getElementById('suggestions-modal'),
        achievementsButton: document.getElementById('achievements-button'),
        achievementsModal: document.getElementById('achievements-modal'),
        forestButton: document.getElementById('forest-button'),
        forestModal: document.getElementById('forest-modal'),
        trajectoryButton: document.getElementById('trajectory-button'),
        trajectoryModal: document.getElementById('trajectory-modal'),
        shareButton: document.getElementById('share-button'),
        shareModal: document.getElementById('share-modal'),
        themeButtonWrapper: document.getElementById('theme-button-wrapper'),
        themeButton: document.getElementById('theme-button'),
        colorPalette: document.getElementById('color-palette'),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        themeIconLight: document.getElementById('theme-icon-light'),
        themeIconDark: document.getElementById('theme-icon-dark'),
        rootElement: document.documentElement,
        mainContainer: document.getElementById('main-container'),
        mainCard: document.getElementById('main-card'),
        statsCard: document.getElementById('stats-card'),
        plantCard: document.getElementById('plant-card'),
        tasksCard: document.getElementById('tasks-card'),
        plantContainer: document.getElementById('plant-container'),
        modeSelector: document.getElementById('mode-selector'),
        statsWorkTimeEl: document.getElementById('stats-work-time'),
        statsBreakTimeEl: document.getElementById('stats-break-time'),
        statsCyclesEl: document.getElementById('stats-cycles'),
        statsChartCanvas: document.getElementById('stats-chart'),
        favicon: document.getElementById('favicon'),
        toastContainer: document.getElementById('toast-container'),
        xpLevel: document.getElementById('xp-level'),
        xpBar: document.getElementById('xp-bar'),
        xpText: document.getElementById('xp-text'),
        addTaskForm: document.getElementById('add-task-form'),
        taskInput: document.getElementById('task-input'),
        taskList: document.getElementById('task-list'),
        notificationsButton: document.getElementById('notifications-button'),
        ambientSoundsControls: document.getElementById('ambient-sounds-controls'),
        friendsButton: document.getElementById('friends-button'),
        friendsModal: document.getElementById('friends-modal'),
    };

    const CONSTANTS = {
        RING_CIRCUMFERENCE: 2 * Math.PI * 45,
        MODES: { POMODORO: 'pomodoro', SHORT_BREAK: 'shortBreak', LONG_BREAK: 'longBreak' }
    };

    const state = {
        durations: { pomodoro: 25 * 60, shortBreak: 5 * 60, longBreak: 15 * 60 },
        timerInterval: null, timeLeft: 0, isPaused: true,
        currentMode: CONSTANTS.MODES.POMODORO,
        pomodoroCount: 0, stats: {}, statsChart: null,
        audio: { synth: null, volumeNode: null, ambientPlayer: null },
        isAiFetching: false, recognition: null, isListening: false,
        gamification: { xp: 0, unlockedAchievements: new Set(), forest: [] },
        tasks: [], activeTaskId: null,
        firebase: { app: null, auth: null, db: null, userId: null, listeners: [] },
        friends: { list: [], requests: [], sessions: {} },
        groupMemberInterval: null,
    };
    
    const themes = {
        cyan:    { light: { accent: '#0ea5e9', hover: '#0284c7', bg: '#ecfeff', cardBg: '#ffffff' }, dark: { accent: '#22d3ee', hover: '#67e8f9', bg: '#083344', cardBg: '#164e63' } },
        rose:    { light: { accent: '#f43f5e', hover: '#e11d48', bg: '#fff1f2', cardBg: '#ffffff' }, dark: { accent: '#fb7185', hover: '#fda4af', bg: '#500724', cardBg: '#881337' } },
        emerald: { light: { accent: '#10b981', hover: '#059669', bg: '#ecfdf5', cardBg: '#ffffff' }, dark: { accent: '#34d399', hover: '#6ee7b7', bg: '#022c22', cardBg: '#065f46' } },
        violet:  { light: { accent: '#8b5cf6', hover: '#7c3aed', bg: '#f5f3ff', cardBg: '#ffffff' }, dark: { accent: '#a78bfa', hover: '#c4b5fd', bg: '#2e1065', cardBg: '#4c1d95' } },
        amber:   { light: { accent: '#f59e0b', hover: '#d97706', bg: '#fffbeb', cardBg: '#ffffff' }, dark: { accent: '#fcd34d', hover: '#fbbf24', bg: '#451a03', cardBg: '#78350f' } }
    };
    
    DOM.progressRing.style.strokeDasharray = CONSTANTS.RING_CIRCUMFERENCE;
    state.timeLeft = state.durations.pomodoro;

    // --- GEMINI API HELPERS ---
    async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) {
                    return response.json();
                }
                if (response.status === 429 || response.status >= 500) { // Throttling or server error
                    await new Promise(resolve => setTimeout(resolve, backoff * Math.pow(2, i)));
                    continue;
                }
                throw new Error(`API Error: ${response.status}`);
            } catch (error) {
                if (i === retries - 1) throw error; // Rethrow last error
                await new Promise(resolve => setTimeout(resolve, backoff * Math.pow(2, i)));
            }
        }
        throw new Error('API request failed after multiple retries.');
    }

    async function handleTaskBreakdown() {
        const taskInput = DOM.taskInput;
        const breakdownBtn = document.getElementById('breakdown-task-btn');
        const taskText = taskInput.value.trim();

        if (!taskText) {
            showToast('Tarea Vac√≠a', 'Escribe una tarea para desglosar.', 'üìù');
            return;
        }

        breakdownBtn.disabled = true;
        breakdownBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
        
        // ADVERTENCIA DE SEGURIDAD:
        // Exponer tu clave de API en el c√≥digo del lado del cliente es muy inseguro.
        // Cualquiera puede verla y usarla. Para producci√≥n, usa una Cloud Function de Firebase como intermediario.
        const apiKey = "AIzaSyBflqnEVC2Ueq1MRC4JuHSnDbMAM5HYk6o"; // <-- REEMPLAZA ESTO CON TU CLAVE DE API REAL
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: `Break this task down into smaller, actionable sub-tasks. Respond in Spanish.: "${taskText}"` }] }],
            systemInstruction: { parts: [{ text: "You are a productivity assistant. Your job is to break down a larger task into smaller, actionable sub-tasks. Return ONLY a JSON object with a single key 'subtasks' which is an array of strings. Do not add any other text or markdown formatting." }] },
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: { "subtasks": { type: "ARRAY", items: { type: "STRING" } } },
                }
            }
        };

        try {
            const result = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const candidate = result.candidates?.[0];
            const jsonText = candidate?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                const parsedJson = JSON.parse(jsonText);
                const subtasks = parsedJson.subtasks;

                if (subtasks && subtasks.length > 0) {
                    subtasks.forEach(task => addTask(task));
                    taskInput.value = '';
                    showToast('¬°√âxito!', `${subtasks.length} subtareas a√±adidas.`, '‚ú®');
                } else {
                    showToast('Error', 'No se pudieron generar subtareas.', 'üòï');
                }
            } else {
                throw new Error("Invalid response structure from API.");
            }
        } catch (error) {
            console.error("Error breaking down task:", error);
            showToast('Error de IA', 'No se pudo contactar al asistente.', 'ü§ñ');
        } finally {
            breakdownBtn.disabled = false;
            breakdownBtn.innerHTML = '‚ú®';
        }
    }

    async function handleGenerateSummary() {
        const summaryDisplay = document.getElementById('ai-summary-display');
        const summaryBtn = document.getElementById('generate-summary-btn');

        if (!summaryDisplay || !summaryBtn) return;

        summaryBtn.disabled = true;
        summaryDisplay.innerHTML = '<p class="italic">‚ú® Generando tu resumen diario...</p>';

        const todayStats = state.stats;
        const workMinutes = Math.round(todayStats.totalWorkTime / 60);
        const breakMinutes = Math.round(todayStats.totalBreakTime / 60);
        const cycles = todayStats.cycleCount;
        const tasksList = todayStats.tasks.map(t => `${t.name} (${t.cycles} ciclos)`).join(', ') || 'ninguna';

        const prompt = `You are an encouraging productivity coach. Based on this data from my Pomodoro session today, write a brief, positive summary of my accomplishments and one simple, actionable tip for tomorrow. Keep it under 60 words. Respond in Spanish. Be friendly and use emojis. Data:\n- Total Work Time: ${workMinutes} minutes\n- Total Break Time: ${breakMinutes} minutes\n- Completed Pomodoros: ${cycles}\n- Tasks Worked On: ${tasksList}`;

        // ADVERTENCIA DE SEGURIDAD:
        // Exponer tu clave de API en el c√≥digo del lado del cliente es muy inseguro.
        // Cualquiera puede verla y usarla. Para producci√≥n, usa una Cloud Function de Firebase como intermediario.
        const apiKey = "YOUR_GEMINI_API_KEY"; // <-- REEMPLAZA ESTO CON TU CLAVE DE API REAL
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const payload = { contents: [{ parts: [{ text: prompt }] }], };

        try {
            const result = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (summaryText) {
                summaryDisplay.innerHTML = summaryText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
            } else {
                throw new Error("Invalid response structure from API.");
            }
        } catch (error) {
            console.error("Error generating summary:", error);
            summaryDisplay.innerHTML = '<p class="text-red-500">No se pudo generar el resumen. Int√©ntalo de nuevo.</p>';
        } finally {
            summaryBtn.disabled = false;
        }
    }

    // --- FIREBASE & FRIENDS ---
    async function initializeFirebase() {
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            state.firebase.app = initializeApp(firebaseConfig);
            state.firebase.db = getFirestore(state.firebase.app);
            state.firebase.auth = getAuth(state.firebase.app);

            onAuthStateChanged(state.firebase.auth, user => {
                if (user) {
                    state.firebase.userId = user.uid;
                    setupRealtimeListeners();
                    updateUserSession();
                } else {
                    state.firebase.userId = null;
                    state.firebase.listeners.forEach(unsubscribe => unsubscribe());
                    state.firebase.listeners = [];
                }
            });
            
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
               await signInWithCustomToken(state.firebase.auth, __initial_auth_token);
            } else {
               await signInAnonymously(state.firebase.auth);
            }

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showToast('Error de Conexi√≥n', 'No se pudo conectar con el servicio de amigos.', '‚ùå');
        }
    }

    function getDbPath(collectionName) {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        return `/artifacts/${appId}/public/data/${collectionName}`;
    }

    function setupRealtimeListeners() {
        if (!state.firebase.userId) return;
        
        state.firebase.listeners.forEach(unsubscribe => unsubscribe());
        state.firebase.listeners = [];

        const userDocRef = doc(state.firebase.db, getDbPath('users'), state.firebase.userId);
        const userListener = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                state.friends.list = docSnap.data().friends || [];
                listenToFriendsStatus();
            } else {
                setDoc(userDocRef, { uid: state.firebase.userId, friends: [] });
            }
            if (DOM.friendsModal.classList.contains('modal-enter')) {
                renderFriendsContent();
            }
        });
        state.firebase.listeners.push(userListener);

        const requestsRef = collection(state.firebase.db, getDbPath('friendRequests'));
        const q = query(requestsRef, where("to", "==", state.firebase.userId), where("status", "==", "pending"));
        const requestsListener = onSnapshot(q, (querySnapshot) => {
            state.friends.requests = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (DOM.friendsModal.classList.contains('modal-enter')) {
                renderFriendsContent();
            }
        });
        state.firebase.listeners.push(requestsListener);
    }
    
    function listenToFriendsStatus() {
        if (state.friends.list.length === 0) {
            state.friends.sessions = {};
            if (DOM.friendsModal.classList.contains('modal-enter')) renderFriendsContent();
            return;
        }
        
        const sessionsRef = collection(state.firebase.db, getDbPath('sessions'));
        const q = query(sessionsRef, where('uid', 'in', state.friends.list));
        
        const friendsListener = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const sessionData = change.doc.data();
                if (change.type === "added" || change.type === "modified") {
                    state.friends.sessions[sessionData.uid] = sessionData;
                }
                if (change.type === "removed") {
                    delete state.friends.sessions[sessionData.uid];
                }
            });
            if (DOM.friendsModal.classList.contains('modal-enter')) {
                 renderFriendsContent();
            }
        });
        state.firebase.listeners.push(friendsListener);
    }

    async function updateUserSession() {
        if (!state.firebase.userId) return;
        const activeTask = state.tasks.find(t => t.id === state.activeTaskId);
        const sessionData = {
            uid: state.firebase.userId,
            currentMode: state.currentMode,
            isPaused: state.isPaused,
            timeLeft: state.timeLeft,
            duration: state.durations[state.currentMode],
            activeTaskText: activeTask ? activeTask.text : 'Ninguna tarea seleccionada',
            lastUpdate: serverTimestamp()
        };
        const sessionDocRef = doc(state.firebase.db, getDbPath('sessions'), state.firebase.userId);
        await setDoc(sessionDocRef, sessionData, { merge: true });
    }

    async function sendFriendRequest() {
        const friendIdInput = document.getElementById('friend-id-input');
        if (!friendIdInput) return;
        const friendId = friendIdInput.value.trim();
        if (!friendId || friendId === state.firebase.userId) {
            showToast('Error', 'ID de amigo inv√°lido.', '‚ùå');
            return;
        }
        
        const friendDocRef = doc(state.firebase.db, getDbPath('users'), friendId);
        const friendDoc = await getDoc(friendDocRef);

        if(!friendDoc.exists()) {
            showToast('Error', 'Usuario no encontrado.', '‚ùå');
            return;
        }

        const requestRef = doc(collection(state.firebase.db, getDbPath('friendRequests')));
        await setDoc(requestRef, {
            from: state.firebase.userId,
            to: friendId,
            status: 'pending',
            createdAt: serverTimestamp()
        });
        showToast('¬°√âxito!', 'Solicitud de amistad enviada.', 'üëç');
        friendIdInput.value = '';
    }

    async function handleFriendRequest(requestId, accept = true) {
        const request = state.friends.requests.find(r => r.id === requestId);
        if(!request) return;

        const requestRef = doc(state.firebase.db, getDbPath('friendRequests'), requestId);
        
        if (accept) {
            const batch = writeBatch(state.firebase.db);
            batch.update(requestRef, { status: "accepted" });

            const currentUserRef = doc(state.firebase.db, getDbPath('users'), state.firebase.userId);
            const friendUserRef = doc(state.firebase.db, getDbPath('users'), request.from);
            
            const [currentUserDoc, friendUserDoc] = await Promise.all([getDoc(currentUserRef), getDoc(friendUserRef)]);

            const currentUserFriends = currentUserDoc.data()?.friends || [];
            const friendUserFriends = friendUserDoc.data()?.friends || [];

            if (!currentUserFriends.includes(request.from)) currentUserFriends.push(request.from);
            if (!friendUserFriends.includes(state.firebase.userId)) friendUserFriends.push(state.firebase.userId);
            
            batch.update(currentUserRef, { friends: currentUserFriends });
            batch.update(friendUserRef, { friends: friendUserFriends });

            await batch.commit();
            showToast('¬°Amigo a√±adido!', `Ahora eres amigo/a de ${request.from.substring(0, 8)}...`, 'ü§ù');
        } else {
            await updateDoc(requestRef, { status: "declined" });
            showToast('Solicitud rechazada', '', 'üëé');
        }
    }

    function generateFriendsModalContent() {
        return `
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Social</h2>
                    <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="flex flex-col space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg mb-6">
                                <h3 class="font-bold mb-2">Tu ID de Amigo</h3>
                                <div class="flex items-center space-x-2 bg-white dark:bg-slate-700 p-2 rounded-md">
                                    <input id="my-user-id" type="text" readonly value="${state.firebase.userId || 'Cargando...'}" class="bg-transparent w-full text-slate-500 dark:text-slate-400 font-mono text-sm">
                                    <button id="copy-my-id" class="p-1 text-slate-500 hover:text-[--color-accent]">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg mb-6">
                                <h3 class="font-bold mb-2">A√±adir Amigo</h3>
                                <form id="add-friend-form" class="flex space-x-2">
                                    <input type="text" id="friend-id-input" placeholder="Pega el ID de tu amigo aqu√≠" class="w-full bg-white dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[--color-accent]">
                                    <button type="submit" class="bg-[--color-accent] hover:bg-[--color-accent-hover] text-white font-bold py-2 px-4 rounded-lg">+</button>
                                </form>
                            </div>
                            <div id="friend-requests-container" class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"></div>
                        </div>
                        <div id="friends-list-container" class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"></div>
                    </div>
                    
                    <div class="border-t-2 border-slate-200 dark:border-slate-700 pt-8">
                        <h2 class="text-2xl font-bold mb-4">Grupos de Trabajo</h2>
                        <div id="group-initial-view">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg">
                                    <h3 class="font-bold mb-2">Crear un Grupo</h3>
                                    <button id="create-group-btn" class="w-full bg-[--color-accent] hover:bg-[--color-accent-hover] text-white dark:text-slate-900 font-bold py-2 px-4 rounded-lg">Crear Nuevo Grupo</button>
                                </div>
                                <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg">
                                    <h3 class="font-bold mb-2">Unirse a un Grupo</h3>
                                    <form class="flex space-x-2">
                                        <input type="text" placeholder="C√≥digo del grupo..." class="w-full bg-white dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[--color-accent]">
                                        <button type="submit" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">Unirse</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div id="active-group-status" class="hidden bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></div>
                                <h3 class="font-bold text-green-500">Grupo Online</h3>
                            </div>
                            <p class="text-slate-500 dark:text-slate-400 mt-2">Se han unido <span id="group-member-count" class="font-bold">1</span> persona(s).</p>
                            <button id="leave-group-btn" class="mt-4 bg-rose-500 hover:bg-rose-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Salir del Grupo</button>
                        </div>

                        <div id="work-groups-list-container" class="mt-6 space-y-4">
                            <h3 class="font-bold">Grupos P√∫blicos</h3>
                            <div class="bg-white dark:bg-slate-700 p-3 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold">üìö Proyecto Final Web</h4>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <div class="flex -space-x-2 overflow-hidden">
                                            <span class="h-6 w-6 rounded-full bg-red-500 text-white flex items-center justify-center text-xs font-bold border-2 border-white dark:border-slate-700">A</span>
                                            <span class="h-6 w-6 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold border-2 border-white dark:border-slate-700">B</span>
                                            <span class="h-6 w-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs font-bold border-2 border-white dark:border-slate-700">C</span>
                                        </div>
                                        <span class="text-xs text-slate-500 dark:text-slate-400">3/5 Miembros | <span class="text-emerald-500 font-semibold">Activo</span></span>
                                    </div>
                                </div>
                                <button class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Unirse</button>
                            </div>
                            <div class="bg-white dark:bg-slate-700 p-3 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold">‚öõÔ∏è Fis. Cu√°ntica II</h4>
                                     <div class="flex items-center space-x-2 mt-1">
                                        <div class="flex -space-x-2 overflow-hidden">
                                            <span class="h-6 w-6 rounded-full bg-yellow-500 text-white flex items-center justify-center text-xs font-bold border-2 border-white dark:border-slate-700">D</span>
                                            <span class="h-6 w-6 rounded-full bg-purple-500 text-white flex items-center justify-center text-xs font-bold border-2 border-white dark:border-slate-700">E</span>
                                        </div>
                                        <span class="text-xs text-slate-500 dark:text-slate-400">2/5 Miembros | <span class="text-amber-500 font-semibold">En Descanso</span></span>
                                    </div>
                                </div>
                                <button class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Unirse</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderFriendsContent() {
        const requestsContainer = document.getElementById('friend-requests-container');
        const friendsListContainer = document.getElementById('friends-list-container');
        if (!requestsContainer || !friendsListContainer) return;

        let requestsHtml = '<h3 class="font-bold mb-2">Solicitudes Pendientes</h3>';
        if (state.friends.requests.length > 0) {
            requestsHtml += '<div class="space-y-2">';
            state.friends.requests.forEach(req => {
                requestsHtml += `<div class="flex justify-between items-center text-sm bg-white dark:bg-slate-700 p-2 rounded-md"><span class="truncate font-mono text-xs" title="${req.from}">De: ${req.from.substring(0, 8)}...</span><div class="flex space-x-1"><button data-request-id="${req.id}" data-action="accept" class="accept-request-btn p-1 bg-emerald-500 text-white rounded-full h-6 w-6 flex items-center justify-center">‚úì</button><button data-request-id="${req.id}" data-action="decline" class="decline-request-btn p-1 bg-rose-500 text-white rounded-full h-6 w-6 flex items-center justify-center">√ó</button></div></div>`;
            });
            requestsHtml += '</div>';
        } else {
            requestsHtml += '<p class="text-sm text-slate-500 dark:text-slate-400 italic">No tienes solicitudes pendientes.</p>';
        }
        requestsContainer.innerHTML = requestsHtml;

        let friendsHtml = '<h3 class="font-bold mb-2">Estado de Amigos</h3>';
        if (state.friends.list.length > 0) {
            friendsHtml += '<div class="space-y-3">';
            state.friends.list.forEach(friendId => {
                const session = state.friends.sessions[friendId];
                if (session) {
                    const progress = session.duration > 0 ? ((session.duration - session.timeLeft) / session.duration) * 100 : 0;
                    const statusClass = session.isPaused ? 'friend-status-paused' : `friend-status-${session.currentMode}`;
                    const statusText = session.isPaused ? 'Pausado' : (session.currentMode === 'pomodoro' ? 'Enfocado' : 'Descansando');
                    friendsHtml += `<div class="bg-white dark:bg-slate-700 p-3 rounded-lg ${statusClass}"><div class="flex justify-between items-center mb-1"><span class="font-bold text-sm truncate font-mono" title="${friendId}">${friendId.substring(0, 8)}...</span><div class="flex items-center space-x-2 text-xs font-semibold"><div class="status-indicator h-2 w-2 rounded-full"></div><span>${statusText}</span></div></div><p class="text-xs text-slate-500 dark:text-slate-400 truncate mb-2">üéØ ${session.activeTaskText}</p><div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-1.5"><div class="friend-progress-bar bg-[--color-accent] h-1.5 rounded-full" style="width: ${progress}%"></div></div></div>`;
                } else {
                     friendsHtml += `<div class="bg-white dark:bg-slate-700 p-3 rounded-lg opacity-60"><span class="font-bold text-sm font-mono" title="${friendId}">${friendId.substring(0, 8)}...</span><p class="text-xs text-slate-500 dark:text-slate-400 italic">Desconectado</p></div>`;
                }
            });
            friendsHtml += '</div>';
        } else {
            friendsHtml += '<p class="text-sm text-slate-500 dark:text-slate-400 italic">A√±ade amigos para ver su estado aqu√≠.</p>';
        }
        friendsListContainer.innerHTML = friendsHtml;
    }

    function createMockGroup() {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const modalContainer = document.createElement('div');
        modalContainer.id = 'group-code-modal';
        modalContainer.className = 'fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[60] p-4';
        modalContainer.innerHTML = `
            <div class="bg-white dark:bg-slate-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center modal-enter">
                <h3 class="font-bold text-xl mb-2">C√≥digo de Grupo Creado</h3>
                <p class="text-slate-500 dark:text-slate-400 mb-4">Comparte este c√≥digo con tus amigos para que se unan:</p>
                <div class="bg-slate-200 dark:bg-slate-700 p-3 rounded-md font-mono text-2xl tracking-widest text-[--color-accent] mb-6">${code}</div>
                <button id="close-code-modal-btn" class="w-full bg-[--color-accent] hover:bg-[--color-accent-hover] text-white dark:text-slate-900 font-bold py-2 px-4 rounded-lg">Entendido</button>
            </div>
        `;
        document.body.appendChild(modalContainer);

        document.getElementById('close-code-modal-btn').onclick = () => {
            modalContainer.remove();
            
            document.getElementById('group-initial-view').classList.add('hidden');
            const activeStatusDiv = document.getElementById('active-group-status');
            const memberCountSpan = document.getElementById('group-member-count');
            
            activeStatusDiv.classList.remove('hidden');
            memberCountSpan.textContent = '1';

            let members = 1;
            if (state.groupMemberInterval) clearInterval(state.groupMemberInterval);
            state.groupMemberInterval = setInterval(() => {
                members++;
                memberCountSpan.textContent = members.toString();
                if (members >= 5) {
                    clearInterval(state.groupMemberInterval);
                }
            }, 3000 + Math.random() * 2000); // Simulate people joining at random intervals
        };
    }

    function leaveMockGroup() {
        if (state.groupMemberInterval) clearInterval(state.groupMemberInterval);
        state.groupMemberInterval = null;

        document.getElementById('active-group-status').classList.add('hidden');
        document.getElementById('group-initial-view').classList.remove('hidden');
        document.getElementById('group-member-count').textContent = '1';
    }

    function setupFriendsModalListeners() {
        const modal = DOM.friendsModal;
        modal.addEventListener('click', e => {
            const target = e.target;
            if (target.id === 'copy-my-id' || target.closest('#copy-my-id')) {
                copyToClipboard(state.firebase.userId, target.closest('button'), '‚úì');
            }
            
            const requestButton = target.closest('.accept-request-btn, .decline-request-btn');
            if (requestButton) {
                handleFriendRequest(requestButton.dataset.requestId, requestButton.dataset.action === 'accept');
            }

            if (target.id === 'create-group-btn') {
                createMockGroup();
            }

            if (target.id === 'leave-group-btn') {
                leaveMockGroup();
            }
        });

        modal.addEventListener('submit', e => {
            if (e.target.id === 'add-friend-form') {
                e.preventDefault();
                sendFriendRequest();
            }
        });
    }

    // --- TASK MANAGEMENT ---
    function renderTasks() {
        DOM.taskList.innerHTML = '';
        if (state.tasks.length === 0) {
            DOM.taskList.innerHTML = '<p class="text-center text-sm text-slate-500 italic">Tu lista de tareas est√° vac√≠a.</p>';
            return;
        }
        state.tasks.forEach(task => {
            const li = document.createElement('li');
            li.className = `task-item flex items-center justify-between p-2 rounded-lg cursor-pointer hover:bg-slate-200/50 dark:hover:bg-slate-700/50 ${task.id === state.activeTaskId ? 'active' : ''}`;
            li.dataset.id = task.id;
            li.innerHTML = `<div class="flex items-center w-full"><input type="checkbox" id="task-check-${task.id}" class="mr-3 h-4 w-4 rounded border-gray-300 text-[--color-accent] focus:ring-[--color-accent]"><label for="task-check-${task.id}" class="task-text flex-grow truncate">${task.text}</label></div><button class="delete-task-btn text-slate-400 hover:text-red-500 text-lg flex-shrink-0 ml-2">&times;</button>`;
            DOM.taskList.appendChild(li);
        });
        if (!state.activeTaskId && state.tasks.length > 0) {
            const firstUncompleted = state.tasks.find(t => !t.completed);
            setActiveTask(firstUncompleted ? firstUncompleted.id : state.tasks[0].id);
        }
    }

    function addTask(text) { if (!text.trim()) return; const newTask = { id: Date.now().toString(), text: text.trim(), completed: false }; state.tasks.push(newTask); DOM.taskInput.value = ''; saveTasks(); renderTasks(); }
    function setActiveTask(taskId) { state.activeTaskId = taskId; saveTasks(); renderTasks(); updateUserSession(); }
    function deleteTask(taskId) { state.tasks = state.tasks.filter(t => t.id !== taskId); if (state.activeTaskId === taskId) state.activeTaskId = null; saveTasks(); renderTasks(); }
    function loadTasks() { state.tasks = JSON.parse(localStorage.getItem('pomodoroTasks')) || []; state.activeTaskId = localStorage.getItem('pomodoroActiveTaskId') || null; renderTasks(); }
    function saveTasks() { localStorage.setItem('pomodoroTasks', JSON.stringify(state.tasks)); if(state.activeTaskId) localStorage.setItem('pomodoroActiveTaskId', state.activeTaskId); else localStorage.removeItem('pomodoroActiveTaskId'); }
    function requestNotificationPermission() { if (!('Notification' in window)) { showToast('Error', 'Este navegador no soporta notificaciones de escritorio.', '‚ùå'); return; } Notification.requestPermission().then(permission => { if (permission === 'granted') { showToast('¬°√âxito!', 'Las notificaciones han sido activadas.', 'üëç'); new Notification('Pomodoro Inteligente', { body: '¬°Gracias por activar las notificaciones!' }); } }); }
    function showNotification(title, body) { if (Notification.permission === 'granted') { new Notification(title, { body: body, icon: 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>'}); } }
    function setupAmbientSounds() { DOM.ambientSoundsControls.addEventListener('click', e => { const sound = e.target.dataset.sound; if(!sound) return; document.querySelectorAll('.ambient-btn').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if (state.audio.ambientPlayer) { state.audio.ambientPlayer.stop(); state.audio.ambientPlayer.dispose(); state.audio.ambientPlayer = null; } if(sound === 'off') return; Tone.start(); if(sound === 'rain') { state.audio.ambientPlayer = new Tone.Noise("pink").toDestination(); state.audio.ambientPlayer.volume.value = -25; state.audio.ambientPlayer.start(); } else if (sound === 'noise') { state.audio.ambientPlayer = new Tone.Noise("brown").toDestination(); state.audio.ambientPlayer.volume.value = -20; state.audio.ambientPlayer.start(); } }); }
    function formatTimeDetailed(totalSeconds) { if (totalSeconds < 60) return "0m"; const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); if (hours > 0) return `${hours}h ${minutes}m`; return `${minutes}m`; }
    function loadStats() { const savedHistory = JSON.parse(localStorage.getItem('pomodoroHistory')) || {}; const today = new Date().toISOString().split('T')[0]; state.stats = savedHistory[today] || { date: today, startTime: null, cycleCount: 0, totalWorkTime: 0, totalBreakTime: 0, hourlyData: Array(24).fill(0), tasks: [] }; if (!state.stats.tasks) state.stats.tasks = []; if (state.stats.totalWorkTime === undefined) state.stats.totalWorkTime = 0; if (state.stats.totalBreakTime === undefined) state.stats.totalBreakTime = 0; }
    function saveStats() { const history = JSON.parse(localStorage.getItem('pomodoroHistory')) || {}; history[state.stats.date] = state.stats; localStorage.setItem('pomodoroHistory', JSON.stringify(history)); }
    function updateStats() { const now = new Date(); if (!state.stats.startTime) state.stats.startTime = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); state.stats.cycleCount++; state.stats.hourlyData[now.getHours()]++; const activeTask = state.tasks.find(t => t.id === state.activeTaskId); const currentTask = activeTask ? activeTask.text : 'Tarea sin nombre'; if (currentTask && !state.stats.tasks.some(t => t.name === currentTask)) { state.stats.tasks.push({name: currentTask, cycles: 1}); } else if (currentTask) { const task = state.stats.tasks.find(t => t.name === currentTask); if(task) task.cycles++; } }
    const XP_PER_POMODORO = 25; const getLevelFromXp = (xp) => Math.floor(Math.pow(xp / 100, 0.7)) + 1; const getXpForLevel = (level) => Math.round(Math.pow(level - 1, 1 / 0.7) * 100); const TREE_SVGS = [ `<svg viewBox="0 0 100 120"><rect x="45" y="90" width="10" height="30" fill="#8B4513"/><polygon points="50,10 20,50 80,50" fill="#228B22"/><polygon points="50,30 25,70 75,70" fill="#2E8B57"/><polygon points="50,50 30,90 70,90" fill="#3CB371"/></svg>`, `<svg viewBox="0 0 100 120"><rect x="45" y="70" width="10" height="50" fill="#A0522D"/><circle cx="50" cy="45" r="35" fill="#006400"/></svg>`, `<svg viewBox="0 0 100 120"><rect x="45" y="80" width="10" height="40" fill="#8B4513"/><path d="M50 10 C 20 40, 80 40, 50 10 Z M20 40 C -10 70, 70 70, 50 40 Z M80 40 C 30 70, 110 70, 50 40 Z" fill="#9ACD32"/></svg>` ]; const ACHIEVEMENTS = { FIRST_STEP: { title: "Primer Tomate", desc: "Completa tu primer ciclo de trabajo.", icon: "üçÖ", check: (agg) => agg.totalPomodoros >= 1 }, APPRENTICE: { title: "Aprendiz", desc: "Completa 10 ciclos de trabajo.", icon: "üßë‚Äçüéì", check: (agg) => agg.totalPomodoros >= 10 }, ADEPT: { title: "Adepto", desc: "Completa 25 ciclos de trabajo.", icon: "ü§ì", check: (agg) => agg.totalPomodoros >= 25 }, MASTER: { title: "Maestro", desc: "Completa 100 ciclos de trabajo.", icon: "üëë", check: (agg) => agg.totalPomodoros >= 100 }, MARATHONER: { title: "Maratonista", desc: "Completa 4 ciclos en un solo d√≠a.", icon: "üèÉ", check: (agg, history) => Object.values(history).some(day => day.cycleCount >= 4) }, STREAK_3: { title: "En Racha", desc: "Completa un ciclo 3 d√≠as seguidos.", icon: "üî•", check: (agg) => agg.currentStreak >= 3 }, STREAK_7: { title: "Imparable", desc: "Completa un ciclo 7 d√≠as seguidos.", icon: "üöÄ", check: (agg) => agg.currentStreak >= 7 }, EARLY_BIRD: { title: "Madrugador", desc: "Completa un ciclo antes de las 8 AM.", icon: "üê¶", check: (agg, history) => Object.values(history).some(day => day.hourlyData.slice(0, 8).some(count => count > 0)) }, NIGHT_OWL: { title: "Nocturno", desc: "Completa un ciclo despu√©s de las 10 PM.", icon: "ü¶â", check: (agg, history) => Object.values(history).some(day => day.hourlyData.slice(22).some(count => count > 0)) }, WEEKENDER: { title: "Currante de Fin de Semana", desc: "Completa un ciclo en s√°bado o domingo.", icon: "üéâ", check: (agg, history) => Object.keys(history).some(dateStr => [0, 6].includes(new Date(dateStr).getDay())) }, };
    function calculateAggregatedStats() { const history = JSON.parse(localStorage.getItem('pomodoroHistory')) || {}; const totalPomodoros = Object.values(history).reduce((sum, day) => sum + (day.cycleCount || 0), 0); const sortedDates = Object.keys(history).filter(d => history[d].cycleCount > 0).sort((a,b) => new Date(a) - new Date(b)); let currentStreak = 0; if (sortedDates.length > 0) { const today = new Date(); today.setHours(0,0,0,0); const lastHistoryDate = new Date(sortedDates[sortedDates.length - 1]); lastHistoryDate.setHours(0,0,0,0); const diffDaysFromToday = Math.round((today - lastHistoryDate) / (1000 * 3600 * 24)); if (diffDaysFromToday <= 1) { currentStreak = 1; for (let i = sortedDates.length - 1; i > 0; i--) { const d1 = new Date(sortedDates[i]); d1.setHours(0,0,0,0); const d2 = new Date(sortedDates[i-1]); d2.setHours(0,0,0,0); if (Math.round((d1 - d2) / (1000 * 3600 * 24)) === 1) { currentStreak++; } else { break; } } } } return { history, totalPomodoros, currentStreak }; }
    function loadGamificationState() { const saved = JSON.parse(localStorage.getItem('pomodoroGamification')); if (saved) { state.gamification.xp = saved.xp || 0; state.gamification.unlockedAchievements = new Set(saved.unlockedAchievements || []); state.gamification.forest = saved.forest || []; } updateXpUI(); }
    function saveGamificationState() { localStorage.setItem('pomodoroGamification', JSON.stringify({ xp: state.gamification.xp, unlockedAchievements: [...state.gamification.unlockedAchievements], forest: state.gamification.forest })); }
    function addXp(amount) { state.gamification.xp += amount; updateXpUI(); saveGamificationState(); }
    function addTreeToForest() { const treeTypeIndex = state.gamification.forest.length % TREE_SVGS.length; const newTree = { svg: TREE_SVGS[treeTypeIndex], date: new Date().toISOString().split('T')[0] }; state.gamification.forest.push(newTree); saveGamificationState(); showToast("¬°Nuevo √°rbol!", "Has cultivado un √°rbol para tu bosque.", "üå≥"); }
    function updateXpUI() { const currentLevel = getLevelFromXp(state.gamification.xp); const xpForCurrentLevel = getXpForLevel(currentLevel); const xpForNextLevel = getXpForLevel(currentLevel + 1); const xpProgress = state.gamification.xp - xpForCurrentLevel; const xpNeeded = xpForNextLevel - xpForCurrentLevel; const percentage = (xpProgress / xpNeeded) * 100; DOM.xpLevel.textContent = `Nivel ${currentLevel}`; DOM.xpBar.style.width = `${percentage}%`; DOM.xpText.textContent = `${xpProgress} / ${xpNeeded} XP`; }
    function checkAchievements() { const { history, ...aggregatedStats } = calculateAggregatedStats(); for (const id in ACHIEVEMENTS) { if (!state.gamification.unlockedAchievements.has(id)) { if (ACHIEVEMENTS[id].check(aggregatedStats, history)) { state.gamification.unlockedAchievements.add(id); showToast(`¬°Medalla Desbloqueada!`, ACHIEVEMENTS[id].title, ACHIEVEMENTS[id].icon); } } } saveGamificationState(); }
    function showToast(title, message, icon) { const toast = document.createElement('div'); toast.className = 'toast-notification bg-white dark:bg-slate-800 rounded-xl shadow-lg p-4 flex items-start space-x-4'; toast.innerHTML = `<div class="text-3xl">${icon}</div><div><p class="font-bold text-slate-800 dark:text-white">${title}</p><p class="text-sm text-slate-600 dark:text-slate-300">${message}</p></div>`; DOM.toastContainer.appendChild(toast); setTimeout(() => toast.remove(), 5000); }
    function updateStatsUI() { DOM.statsWorkTimeEl.textContent = `${Math.round(state.stats.totalWorkTime / 60)} min`; DOM.statsBreakTimeEl.textContent = `${Math.round(state.stats.totalBreakTime / 60)} min`; DOM.statsCyclesEl.textContent = state.stats.cycleCount; updatePlantGrowth(); updateXpUI(); if (state.statsChart) { const accentColor = getComputedStyle(DOM.rootElement).getPropertyValue('--color-accent'); const isDark = DOM.rootElement.classList.contains('dark'); const tickColor = isDark ? 'rgb(156 163 175)' : 'rgb(75 85 99)'; state.statsChart.data.datasets[0].data = state.stats.hourlyData; state.statsChart.data.datasets[0].backgroundColor = accentColor; state.statsChart.options.scales.x.ticks.color = tickColor; state.statsChart.options.scales.y.ticks.color = tickColor; state.statsChart.update(); } }
    function updatePlantGrowth() { const cycles = state.stats.cycleCount % 10; const stages = [ { svg: `<svg width="150" height="150" viewBox="0 0 100 100"><path d="M 30 90 Q 50 80 70 90" stroke="#8B4513" fill="#A0522D" stroke-width="2"/></svg>`, text: "Completa un ciclo para plantar la semilla." }, { svg: `<svg width="150" height="150" viewBox="0 0 100 100"><path d="M 30 90 Q 50 80 70 90" stroke="#8B4513" fill="#A0522D" stroke-width="2"/><path d="M 50 85 C 55 75, 45 75, 50 65" stroke="#228B22" fill="none" stroke-width="3" stroke-linecap="round"/></svg>`, text: "¬°La semilla ha brotado!" }, { svg: `<svg width="150" height="150" viewBox="0 0 100 100"><path d="M 30 90 Q 50 80 70 90" stroke="#8B4513" fill="#A0522D" stroke-width="2"/><path d="M 50 85 V 50 M 50 65 C 40 60, 40 50, 50 50 M 50 65 C 60 60, 60 50, 50 50" stroke="#228B22" fill="none" stroke-width="3" stroke-linecap="round"/></svg>`, text: "¬°Sigue as√≠!" }, { svg: `<svg width="150" height="150" viewBox="0 0 100 100"><path d="M 30 90 Q 50 80 70 90" stroke="#8B4513" fill="#A0522D" stroke-width="2"/><path d="M 50 85 V 35 M 50 65 C 35 60, 35 45, 50 45 M 50 65 C 65 60, 65 45, 50 45 M 50 50 C 40 45, 40 35, 50 35 M 50 50 C 60 45, 60 35, 50 35" stroke="#228B22" fill="none" stroke-width="4" stroke-linecap="round"/></svg>`, text: "¬°Tu planta est√° creciendo fuerte!" }, { svg: `<svg width="150" height="150" viewBox="0 0 100 100"><path d="M 30 90 Q 50 80 70 90" stroke="#8B4513" fill="#A0522D" stroke-width="2"/><path d="M 50 85 V 35 M 50 70 C 30 65, 30 45, 50 45 M 50 70 C 70 65, 70 45, 50 45 M 50 55 C 35 50, 35 35, 50 35 M 50 55 C 65 50, 65 35, 50 35" stroke="#228B22" fill="none" stroke-width="5" stroke-linecap="round"/><circle cx="50" cy="25" r="10" fill="var(--color-accent)"/><circle cx="50" cy="25" r="4" fill="yellow"/></svg>`, text: "¬°Ha florecido! ¬°Felicidades!" } ]; let stage; if (cycles === 0) stage = stages[0]; else if (cycles <= 2) stage = stages[1]; else if (cycles <= 5) stage = stages[2]; else if (cycles <= 8) stage = stages[3]; else stage = stages[4]; DOM.plantContainer.innerHTML = `${stage.svg}<p class="text-xs text-center text-slate-500 mt-2">${stage.text}</p>`; }
    function updateFavicon() { if (state.isPaused) { DOM.favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>`; return; } const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64; const ctx = canvas.getContext('2d'); const accentColor = getComputedStyle(DOM.rootElement).getPropertyValue('--color-accent'); ctx.beginPath(); ctx.arc(32, 32, 28, -Math.PI / 2, 2 * Math.PI * (state.timeLeft / state.durations[state.currentMode]) - Math.PI / 2, true); ctx.strokeStyle = '#9ca3af'; ctx.lineWidth = 8; ctx.stroke(); ctx.beginPath(); ctx.arc(32, 32, 28, -Math.PI / 2, 2 * Math.PI * (state.timeLeft / state.durations[state.currentMode]) - Math.PI / 2); ctx.strokeStyle = accentColor; ctx.lineWidth = 8; ctx.stroke(); const minutes = Math.ceil(state.timeLeft / 60); ctx.fillStyle = accentColor; ctx.font = 'bold 28px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(minutes, 32, 32); DOM.favicon.href = canvas.toDataURL('image/png'); }
    function toggleDarkMode() { DOM.rootElement.classList.toggle('dark'); const isDark = DOM.rootElement.classList.contains('dark'); localStorage.setItem('pomodoroTheme', isDark ? 'dark' : 'light'); updateThemeUI(); }
    function updateThemeUI() { const isDark = DOM.rootElement.classList.contains('dark'); DOM.themeIconDark.classList.toggle('hidden', !isDark); DOM.themeIconLight.classList.toggle('hidden', isDark); const savedAccent = localStorage.getItem('pomodoroAccent') || 'cyan'; applyAccentColor(savedAccent); }
    function setupAudio() { const savedVolume = localStorage.getItem('pomodoroVolume') || '0.5'; const initialVolume = parseFloat(savedVolume); const initialDb = Tone.gainToDb(initialVolume); state.audio.volumeNode = new Tone.Volume(initialDb).toDestination(); state.audio.synth = new Tone.Synth().connect(state.audio.volumeNode); DOM.volumeSlider.value = initialVolume; }
    function playNotificationSound(type = 'workEnd') { if (state.audio.synth && typeof Tone !== 'undefined' && state.audio.volumeNode.volume.value > -Infinity) { Tone.start(); if (type === 'workEnd') { state.audio.synth.triggerAttackRelease("C5", "8n", Tone.now()); setTimeout(() => state.audio.synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.15), 150); setTimeout(() => state.audio.synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.3), 300); } else { state.audio.synth.triggerAttackRelease("G5", "8n", Tone.now()); setTimeout(() => state.audio.synth.triggerAttackRelease("C5", "8n", Tone.now() + 0.2), 200); } } }
    function applyAccentColor(themeName) { const theme = themes[themeName]; if (!theme) return; const mode = DOM.rootElement.classList.contains('dark') ? 'dark' : 'light'; DOM.rootElement.style.setProperty('--color-accent', theme[mode].accent); DOM.rootElement.style.setProperty('--color-accent-hover', theme[mode].hover); document.body.style.backgroundColor = theme[mode].bg; [DOM.mainCard, DOM.statsCard, DOM.tasksCard, DOM.plantCard].forEach(card => { if(card) card.style.backgroundColor = theme[mode].cardBg; }); localStorage.setItem('pomodoroAccent', themeName); document.querySelectorAll('#color-palette button').forEach(btn => { btn.style.borderColor = btn.dataset.theme === themeName ? theme[mode].accent : 'transparent'; }); updateStatsUI(); updateFavicon(); }
    function enterFocusMode() { [DOM.statsCard, DOM.plantCard.parentElement, DOM.themeButtonWrapper, DOM.menuButton, DOM.volumeButton, DOM.modeSelector.parentElement, DOM.resetButton, DOM.darkModeToggle, DOM.voiceControlButton.parentElement].forEach(el => { if (el) el.classList.add('hidden'); }); [DOM.mainMenu, DOM.volumeSliderContainer, DOM.suggestionsModal].forEach(el => { if (el) el.classList.add('hidden'); }); DOM.mainContainer.classList.remove('lg:grid-cols-3', 'max-w-7xl', 'lg:gap-8'); DOM.mainContainer.classList.add('max-w-md'); DOM.mainCard.classList.remove('lg:col-start-2'); }
    function exitFocusMode() { [DOM.statsCard, DOM.plantCard.parentElement, DOM.themeButtonWrapper, DOM.menuButton, DOM.volumeButton, DOM.modeSelector.parentElement, DOM.resetButton, DOM.darkModeToggle, DOM.voiceControlButton.parentElement].forEach(el => { if (el) el.classList.remove('hidden'); }); DOM.mainContainer.classList.add('lg:grid-cols-3', 'max-w-7xl', 'lg:gap-8'); DOM.mainContainer.classList.remove('max-w-md'); DOM.mainCard.classList.add('lg:col-start-2'); }
    function updateTimerDisplay() { const minutes = Math.floor(state.timeLeft / 60); const seconds = state.timeLeft % 60; const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; DOM.timeDisplay.textContent = timeString; const activeTask = state.tasks.find(t => t.id === state.activeTaskId); document.title = `${timeString} - ${state.currentMode === 'pomodoro' ? (activeTask?.text || 'Trabajo') : 'Descanso'}`; const totalTime = state.durations[state.currentMode]; const progress = (totalTime - state.timeLeft) / totalTime; const offset = CONSTANTS.RING_CIRCUMFERENCE * (1 - progress); DOM.progressRing.style.strokeDashoffset = offset; updateFavicon(); updateUserSession(); }
    function toggleTimer() { if (state.currentMode === 'pomodoro' && !state.activeTaskId) { showToast('¬°Atenci√≥n!', 'Selecciona una tarea antes de empezar.', 'üëâ'); return; } state.isPaused ? startTimer() : pauseTimer(); }
    function startTimer() { state.isPaused = false; DOM.startPauseButton.textContent = 'Pausar'; enterFocusMode(); if (state.timeLeft === state.durations[state.currentMode]) { state.timeLeft--; } updateTimerDisplay(); state.timerInterval = setInterval(() => { if (state.timeLeft <= 0) { clearInterval(state.timerInterval); switchToNextMode(); return; } state.timeLeft--; updateTimerDisplay(); }, 1000); }
    function pauseTimer() { state.isPaused = true; DOM.startPauseButton.textContent = 'Continuar'; clearInterval(state.timerInterval); exitFocusMode(); updateUserSession(); }
    function resetTimer() { clearInterval(state.timerInterval); state.isPaused = true; DOM.startPauseButton.textContent = 'Empezar'; state.timeLeft = state.durations[state.currentMode]; exitFocusMode(); updateTimerDisplay(); DOM.aiSuggestionBox.classList.add('opacity-0'); document.title = "Temporizador Pomodoro Inteligente"; }
    function switchToNextMode() { const completedDuration = state.durations[state.currentMode]; const completedMode = state.currentMode; if (completedMode === CONSTANTS.MODES.POMODORO) { playNotificationSound('workEnd'); state.stats.totalWorkTime += completedDuration; updateStats(); if (state.stats.cycleCount > 0 && state.stats.cycleCount % 10 === 0) { addTreeToForest(); } addXp(XP_PER_POMODORO); checkAchievements(); showNotification('¬°Buen trabajo!', 'T√≥mate un merecido descanso.'); } else { playNotificationSound('breakEnd'); state.stats.totalBreakTime += completedDuration; showNotification('¬°Descanso terminado!', 'Es hora de volver a enfocarse.'); } saveStats(); updateStatsUI(); let nextMode; if (completedMode === CONSTANTS.MODES.POMODORO) { state.pomodoroCount++; nextMode = (state.pomodoroCount % 4 === 0) ? CONSTANTS.MODES.LONG_BREAK : CONSTANTS.MODES.SHORT_BREAK; generateAiSuggestion(); } else { if (completedMode === CONSTANTS.MODES.LONG_BREAK) state.pomodoroCount = 0; nextMode = CONSTANTS.MODES.POMODORO; } changeMode(nextMode, true); }
    function changeMode(newMode, autoStart = false) { clearInterval(state.timerInterval); state.currentMode = newMode; updateActiveModeButton(newMode); if (!autoStart && newMode === CONSTANTS.MODES.POMODORO) { state.pomodoroCount = 0; } resetTimer(); if (autoStart) startTimer(); }
    function updateActiveModeButton(mode) { document.querySelectorAll('.mode-select-btn').forEach(button => { button.classList.toggle('active-mode', button.dataset.mode === mode); }); }
    function enterEditMode() { if (!state.isPaused) return; DOM.timeDisplay.classList.add('hidden'); const timeInput = document.createElement('input'); timeInput.type = 'number', timeInput.id = 'time-input-edit', timeInput.min = '1', timeInput.max = '90'; timeInput.value = Math.floor(state.durations[state.currentMode] / 60); timeInput.className = 'w-40 text-center bg-transparent text-6xl md:text-7xl font-extrabold z-10 text-[--color-accent] focus:outline-none'; DOM.timeDisplayWrapper.appendChild(timeInput); timeInput.focus(); timeInput.select(); const saveTime = () => { const newMinutes = parseInt(timeInput.value, 10); if (!isNaN(newMinutes) && newMinutes > 0 && newMinutes <= 90) { const newDuration = newMinutes * 60; state.durations[state.currentMode] = newDuration; localStorage.setItem(`${state.currentMode}Duration`, newDuration); state.timeLeft = newDuration; updateTimerDisplay(); } timeInput.remove(); DOM.timeDisplay.classList.remove('hidden'); }; timeInput.addEventListener('blur', saveTime); timeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') timeInput.blur(); else if (e.key === 'Escape') { timeInput.value = Math.floor(state.durations[state.currentMode] / 60); timeInput.blur(); } }); }
    function renderHistory(period = 'weekly') { const history = JSON.parse(localStorage.getItem('pomodoroHistory')) || {}; const historyWrapper = DOM.historyModal.querySelector('#history-content-wrapper'); if (!historyWrapper) return; if (Object.keys(history).length === 0) { historyWrapper.innerHTML = '<p class="text-slate-500 text-center">No hay datos hist√≥ricos todav√≠a.</p>'; return; } let contentHtml = '<div class="space-y-4">'; const sortedDates = Object.keys(history).sort((a, b) => new Date(b) - new Date(a)); if (period === 'weekly') { const weeks = {}; sortedDates.forEach(dateStr => { const dayData = history[dateStr]; const date = new Date(dateStr); date.setHours(12); const dayOfWeek = date.getDay(); const weekStartDate = new Date(date); weekStartDate.setDate(date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); const weekStartStr = weekStartDate.toISOString().split('T')[0]; if (!weeks[weekStartStr]) { weeks[weekStartStr] = { days: [], totalCycles: 0, totalWorkTime: 0, totalBreakTime: 0 }; } weeks[weekStartStr].days.push({ dateStr, data: dayData }); weeks[weekStartStr].totalCycles += dayData.cycleCount || 0; weeks[weekStartStr].totalWorkTime += dayData.totalWorkTime || 0; weeks[weekStartStr].totalBreakTime += dayData.totalBreakTime || 0; }); for (const weekStartStr in weeks) { const week = weeks[weekStartStr]; const weekStartDate = new Date(weekStartStr); const totalWeekTime = week.totalWorkTime + week.totalBreakTime; const focusRatio = totalWeekTime > 0 ? Math.round((week.totalWorkTime / totalWeekTime) * 100) : 0; contentHtml += `<div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"> <div class="flex justify-between items-center mb-3 border-b border-slate-300 dark:border-slate-600 pb-2"> <div> <h3 class="font-bold">Semana del ${weekStartDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })}</h3> <div class="text-xs text-slate-500 dark:text-slate-400 flex space-x-3 mt-1"> <span>üí™ Trabajo: <b>${formatTimeDetailed(week.totalWorkTime)}</b></span> <span>‚òï Descanso: <b>${formatTimeDetailed(week.totalBreakTime)}</b></span> </div> </div> <div class="text-right"> <span class="font-extrabold text-lg text-[--color-accent]">${week.totalCycles} ciclos</span> <div class="text-sm font-semibold text-slate-600 dark:text-slate-300">${focusRatio}% Foco</div> </div> </div>`; week.days.sort((a,b) => new Date(a.dateStr) - new Date(b.dateStr)).forEach(({ dateStr, data }) => { const date = new Date(dateStr); date.setHours(12); const tasks = (data.tasks && data.tasks.length > 0) ? data.tasks.map(t => `${t.name} (${t.cycles})`).join(', ') : 'Sin tareas registradas'; contentHtml += `<div class="ml-2 mt-2"> <div class="flex justify-between items-center text-sm"> <span class="font-medium capitalize">${date.toLocaleDateString('es-ES', { weekday: 'long' })}</span> <div class="flex items-center space-x-3 text-xs text-slate-500 dark:text-slate-400"> <span>${formatTimeDetailed(data.totalWorkTime || 0)}</span> <span class="font-bold text-[--color-accent]">${data.cycleCount} ciclos</span> </div> </div> <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 truncate" title="${tasks}">üéØ ${tasks}</p> </div>`; }); contentHtml += `</div>`; } } else if (period === 'monthly' || period === 'yearly') { const aggregates = {}; sortedDates.forEach(dateStr => { const dayData = history[dateStr]; const date = new Date(dateStr); const key = (period === 'monthly') ? `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` : date.getFullYear().toString(); if (!aggregates[key]) aggregates[key] = { cycleCount: 0, totalWorkTime: 0, totalBreakTime: 0, taskMap: new Map() }; aggregates[key].cycleCount += dayData.cycleCount || 0; aggregates[key].totalWorkTime += dayData.totalWorkTime || 0; aggregates[key].totalBreakTime += dayData.totalBreakTime || 0; (dayData.tasks || []).forEach(task => { aggregates[key].taskMap.set(task.name, (aggregates[key].taskMap.get(task.name) || 0) + task.cycles); }); }); for (const key in aggregates) { const data = aggregates[key]; const topTasks = [...data.taskMap.entries()].sort((a,b) => b[1] - a[1]).slice(0, 3).map(t => t[0]).join(', '); const totalTime = data.totalWorkTime + data.totalBreakTime; const focusRatio = totalTime > 0 ? Math.round((data.totalWorkTime / totalTime) * 100) : 0; let title = key; if (period === 'monthly') { const [year, month] = key.split('-'); const date = new Date(year, month - 1); title = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }); } contentHtml += `<div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"> <div class="flex justify-between items-center"> <div> <h3 class="font-bold capitalize">${title}</h3> <div class="text-xs text-slate-500 dark:text-slate-400 flex space-x-3 mt-1"> <span>üí™ Trabajo: <b>${formatTimeDetailed(data.totalWorkTime)}</b></span> <span>‚òï Descanso: <b>${formatTimeDetailed(data.totalBreakTime)}</b></span> </div> </div> <div class="text-right"> <span class="font-extrabold text-lg text-[--color-accent]">${data.cycleCount} ciclos</span> <div class="text-sm font-semibold text-slate-600 dark:text-slate-300">${focusRatio}% Foco</div> </div> </div> <p class="text-xs text-slate-500 dark:text-slate-400 mt-2 pt-2 border-t border-slate-300 dark:border-slate-600" title="Tareas principales: ${topTasks}">üéØ Tareas principales: ${topTasks || 'Ninguna'}</p> </div>`; } } contentHtml += '</div>'; historyWrapper.innerHTML = contentHtml; }
    function openModal(modalElement, contentHTML, setupCallback) { modalElement.innerHTML = contentHTML; modalElement.classList.remove('hidden', 'modal-leave'); modalElement.classList.add('modal-enter'); modalElement.querySelector('[data-close-modal]')?.addEventListener('click', () => closeModal(modalElement)); if (setupCallback) setupCallback(); }
    function closeModal(modalElement) { modalElement.classList.remove('modal-enter'); modalElement.classList.add('modal-leave'); setTimeout(() => { modalElement.classList.add('hidden'); modalElement.innerHTML = ''; }, 300); }
    function generateHistoryModalContent() { return ` <div class="max-w-4xl mx-auto"> <div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Historial de Productividad</h2> <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div class="border-b border-slate-200 dark:border-slate-700 mb-6"> <nav class="-mb-px flex space-x-6" aria-label="Tabs"> <button data-period="weekly" class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-200 dark:hover:border-slate-500">Semanas</button> <button data-period="monthly" class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-200 dark:hover:border-slate-500">Meses</button> <button data-period="yearly" class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-200 dark:hover:border-slate-500">A√±os</button> </nav> </div> <div id="history-content-wrapper"></div> </div> `; }
    const suggestionModalContent = ` <div class="max-w-4xl mx-auto"> <div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Banco de Ideas para Descansos</h2> <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div class="text-center mb-8 bg-slate-200/50 dark:bg-slate-800/50 p-6 rounded-lg"> <h3 class="text-xl font-bold mb-4 text-slate-700 dark:text-slate-200">¬øNo sabes qu√© hacer?</h3> <button id="random-suggestion-button" class="bg-[--color-accent] hover:bg-[--color-accent-hover] text-white dark:text-slate-900 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">Generar Sugerencia Aleatoria</button> <div id="random-suggestion-display" class="mt-4 text-lg font-medium min-h-[3.5rem] flex items-center justify-center p-3 rounded-md bg-white dark:bg-slate-700/80 shadow-inner"> <p class="text-slate-500 dark:text-slate-400 italic">¬°Pulsa el bot√≥n para recibir una idea!</p> </div> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"><h3 class="text-xl font-bold mb-4 text-[--color-accent]">üí™ F√≠sico</h3><ul class="space-y-3 text-slate-600 dark:text-slate-300"><li><span class="mr-2">ü§∏</span>Estiramiento de cuello y hombros.</li><li><span class="mr-2">üö∂</span>Paseo corto por la habitaci√≥n.</li><li><span class="mr-2">üíß</span>Rellena tu botella de agua.</li><li><span class="mr-2">üï∫</span>Baila tu canci√≥n favorita.</li><li><span class="mr-2">üèãÔ∏è</span>10 sentadillas o flexiones.</li></ul></div> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"><h3 class="text-xl font-bold mb-4 text-[--color-accent]">üß† Mental</h3><ul class="space-y-3 text-slate-600 dark:text-slate-300"><li><span class="mr-2">üßò</span>Meditaci√≥n breve (1-2 min).</li><li><span class="mr-2">üèûÔ∏è</span>Mira por la ventana a lo lejos.</li><li><span class="mr-2">üòå</span>Respira hondo 5 veces.</li><li><span class="mr-2">üé∂</span>Escucha una canci√≥n relajante.</li><li><span class="mr-2">üß©</span>Haz un puzzle r√°pido online.</li></ul></div> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"><h3 class="text-xl font-bold mb-4 text-[--color-accent]">üé® Pr√°ctico</h3><ul class="space-y-3 text-slate-600 dark:text-slate-300"><li><span class="mr-2">‚úçÔ∏è</span>Haz un garabato o dibujo.</li><li><span class="mr-2">üßπ</span>Ordena un caj√≥n o estante.</li><li><span class="mr-2">üôè</span>Agradece tres cosas del d√≠a.</li><li><span class="mr-2">üìñ</span>Lee una p√°gina de un libro.</li><li><span class="mr-2">üìß</span>Archiva 5 correos electr√≥nicos.</li></ul></div> </div> </div> `;
    function generateAchievementsModalContent() { let unlockedCount = state.gamification.unlockedAchievements.size; let totalCount = Object.keys(ACHIEVEMENTS).length; let content = ` <div class="max-w-4xl mx-auto"> <div class="flex justify-between items-center mb-6"> <div> <h2 class="text-3xl font-bold">Mis Medallas</h2> <p class="text-slate-500 dark:text-slate-400">Has desbloqueado ${unlockedCount} de ${totalCount} medallas.</p> </div> <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`; for (const id in ACHIEVEMENTS) { const ach = ACHIEVEMENTS[id]; const isUnlocked = state.gamification.unlockedAchievements.has(id); content += ` <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg text-center transition-opacity ${isUnlocked ? 'opacity-100' : 'opacity-50'}"> <div class="text-6xl ${isUnlocked ? '' : 'grayscale'}">${ach.icon}</div> <h3 class="font-bold mt-2 text-slate-800 dark:text-slate-100">${ach.title}</h3> <p class="text-xs text-slate-500 dark:text-slate-400 h-10">${ach.desc}</p> </div> `; } content += `</div></div>`; return content; }
    function generateForestModalContent() { let content = ` <div class="max-w-4xl mx-auto"> <div class="flex justify-between items-center mb-6"> <div> <h2 class="text-3xl font-bold">Mi Bosque</h2> <p class="text-slate-500 dark:text-slate-400">Cada 10 ciclos de trabajo en un d√≠a, cultivas un nuevo √°rbol.</p> </div> <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div id="forest-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 p-4 bg-slate-200/50 dark:bg-slate-800/50 rounded-lg min-h-[300px] items-end">`; if (state.gamification.forest.length === 0) { content += `<p class="col-span-full text-center text-slate-500 dark:text-slate-400 self-center">Tu bosque est√° vac√≠o. ¬°Completa 10 ciclos hoy para plantar tu primer √°rbol!</p>`; } else { state.gamification.forest.forEach(tree => { content += ` <div class="text-center" title="Plantado el ${new Date(tree.date).toLocaleDateString('es-ES')}"> <div class="w-full h-auto aspect-[100/120]">${tree.svg}</div> </div> `; }); } content += `</div></div>`; return content; }
    function generateTrajectoryModalContent() { const { totalPomodoros, currentStreak, history } = calculateAggregatedStats(); const totalFocusTime = Object.values(history).reduce((sum, day) => sum + (day.totalWorkTime || 0), 0); let weeklyActivity = ''; const dayNames = ['D', 'L', 'M', 'X', 'J', 'V', 'S']; for (let i = 6; i >= 0; i--) { const date = new Date(); date.setDate(date.getDate() - i); const dateStr = date.toISOString().split('T')[0]; const isActive = history[dateStr] && history[dateStr].cycleCount > 0; weeklyActivity += ` <div class="text-center"> <div class="w-10 h-10 rounded-full flex items-center justify-center ${isActive ? 'bg-[--color-accent] text-white' : 'bg-slate-200 dark:bg-slate-700'}">${dayNames[date.getDay()]}</div> </div> `; } let content = ` <div class="max-w-4xl mx-auto"> <div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Mi Trayectoria de Foco</h2> <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div class="grid grid-cols-1 md:grid-cols-3 gap-6"> <div class="md:col-span-1 flex flex-col items-center justify-center bg-slate-200/50 dark:bg-slate-800/50 p-6 rounded-lg"> <svg viewBox="0 0 100 100" class="w-24 h-24"> <g class="owl-anim-body"> <path d="M50 10 C 20 10, 10 40, 10 60 C 10 90, 40 100, 50 100 C 60 100, 90 90, 90 60 C 90 40, 80 10, 50 10 Z" fill="#A0522D"></path> <path d="M30 60 C 20 70, 40 70, 50 60 C 60 70, 80 70, 70 60" fill="#D2B48C"></path> <polygon points="50,55 45,65 55,65" fill="#FFA500"></polygon> <path d="M20 20 Q 10 10, 30 15" stroke="#654321" stroke-width="4" fill="none" stroke-linecap="round"></path> <path d="M80 20 Q 90 10, 70 15" stroke="#654321" stroke-width="4" fill="none" stroke-linecap="round"></path> <g class="owl-anim-eyes"> <circle cx="35" cy="45" r="12" fill="white"></circle> <circle cx="65" cy="45" r="12" fill="white"></circle> <circle cx="35" cy="45" r="5" fill="black"></circle> <circle cx="65" cy="45" r="5" fill="black"></circle> </g> </g> </svg> <p class="mt-4 text-center font-medium">¬°Sigue as√≠, tu esfuerzo est√° dando sus frutos!</p> </div> <div class="md:col-span-2 space-y-4"> <div class="grid grid-cols-2 gap-4"> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg text-center"> <p class="text-sm text-slate-500 dark:text-slate-400">Racha Actual</p> <p class="text-4xl font-bold text-[--color-accent]">${currentStreak} üî•</p> <p class="text-xs text-slate-500 dark:text-slate-400">d√≠as seguidos</p> </div> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg text-center"> <p class="text-sm text-slate-500 dark:text-slate-400">Nivel de Foco</p> <p class="text-4xl font-bold text-[--color-accent]">${getLevelFromXp(state.gamification.xp)}</p> <p class="text-xs text-slate-500 dark:text-slate-400">${state.gamification.xp} XP totales</p> </div> </div> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg"> <p class="text-sm text-slate-500 dark:text-slate-400 mb-2 font-bold">Actividad Semanal</p> <div class="flex justify-between">${weeklyActivity}</div> </div> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg grid grid-cols-2 gap-4 text-center"> <div> <p class="text-sm text-slate-500 dark:text-slate-400">Ciclos Totales</p> <p class="text-2xl font-bold text-[--color-accent]">${totalPomodoros}</p> </div> <div> <p class="text-sm text-slate-500 dark:text-slate-400">Tiempo Total de Foco</p> <p class="text-2xl font-bold text-[--color-accent]">${formatTimeDetailed(totalFocusTime)}</p> </div> </div> </div> </div> <div class="md:col-span-3 mt-6 border-t border-slate-300 dark:border-slate-700 pt-6"> <h3 class="font-bold text-lg mb-2 text-center">Resumen del D√≠a con IA</h3> <div id="ai-summary-container" class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg min-h-[100px] flex flex-col items-center justify-center"> <div id="ai-summary-display" class="text-slate-600 dark:text-slate-300 text-center"></div> <button id="generate-summary-btn" class="mt-4 bg-[--color-accent] hover:bg-[--color-accent-hover] text-white dark:text-slate-900 font-bold py-2 px-6 rounded-lg">‚ú® Generar Resumen</button> </div> </div> </div>`; return content; }
    function setupSuggestionModal() { const randomButton = document.getElementById('random-suggestion-button'); const display = document.getElementById('random-suggestion-display'); const allSuggestions = document.querySelectorAll('#suggestions-modal ul li'); if (randomButton && display && allSuggestions.length > 0) { randomButton.addEventListener('click', () => { const randomIndex = Math.floor(Math.random() * allSuggestions.length); const randomSuggestionHTML = allSuggestions[randomIndex].innerHTML; display.innerHTML = `<p class="transition-all duration-300">${randomSuggestionHTML}</p>`; display.classList.add('animate-pulse-quick'); setTimeout(() => display.classList.remove('animate-pulse-quick'), 500); }); } }
    function generateShareModalContent() { const { totalPomodoros } = calculateAggregatedStats(); const level = getLevelFromXp(state.gamification.xp); const shareText = `¬°He completado ${totalPomodoros} ciclos de trabajo y alcanzado el Nivel ${level} en mi Pomodoro Inteligente! üçÖüí™`; const appUrl = window.location.href; const encodedText = encodeURIComponent(shareText); const encodedUrl = encodeURIComponent(appUrl); return ` <div class="max-w-lg mx-auto text-center"> <div class="flex justify-between items-center mb-6"> <h2 class="text-3xl font-bold">Comparte tu Progreso</h2> <button data-close-modal class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div class="bg-slate-200/50 dark:bg-slate-800/50 p-4 rounded-lg mb-6"> <p id="share-text-display" class="text-slate-700 dark:text-slate-200">${shareText}</p> </div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <a href="https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}" target="_blank" class="flex items-center justify-center bg-[#1DA1F2] text-white font-bold py-3 px-4 rounded-lg w-full">Compartir en X</a> <a href="https://api.whatsapp.com/send?text=${encodedText}%20${encodedUrl}" target="_blank" class="flex items-center justify-center bg-[#25D366] text-white font-bold py-3 px-4 rounded-lg w-full">Compartir en WhatsApp</a> <a href="https://www.snapchat.com/" target="_blank" class="flex items-center justify-center bg-[#FFFC00] text-black font-bold py-3 px-4 rounded-lg w-full">Ir a Snapchat</a> <a href="https://www.instagram.com" target="_blank" class="flex items-center justify-center bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white font-bold py-3 px-4 rounded-lg w-full">Ir a Instagram</a> </div> </div>`; }
    function copyToClipboard(text, buttonElement, successMessage) { const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); const originalText = buttonElement.innerHTML; const successIcon = '‚úì'; buttonElement.innerHTML = successIcon; setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000); } catch (err) { console.error('Error al copiar: ', err); } document.body.removeChild(textArea); }
    function initializeChart() { const isDark = DOM.rootElement.classList.contains('dark'); const accentColor = getComputedStyle(DOM.rootElement).getPropertyValue('--color-accent'); const tickColor = isDark ? 'rgb(156 163 175)' : 'rgb(75 85 99)'; state.statsChart = new Chart(DOM.statsChartCanvas, { type: 'bar', data: { labels: Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0')), datasets: [{ label: 'Ciclos Completados', data: state.stats.hourlyData, backgroundColor: accentColor, borderRadius: 4, borderSkipped: false }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.raw} ciclos` } } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: tickColor }, grid: { color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' } }, x: { ticks: { color: tickColor }, grid: { display: false } } } } }); }
    function setupVoiceRecognition() { const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SpeechRecognition) { DOM.voiceControlButton.disabled = true; DOM.voiceControlButton.title = "El reconocimiento de voz no es compatible con este navegador."; DOM.voiceControlButton.classList.add('opacity-50', 'cursor-not-allowed'); console.warn("Speech Recognition API not supported."); return; } state.recognition = new SpeechRecognition(); state.recognition.lang = 'es-ES'; state.recognition.continuous = false; state.recognition.interimResults = false; DOM.voiceControlButton.addEventListener('click', toggleListening); state.recognition.onresult = handleVoiceResult; state.recognition.onerror = (event) => { console.error('Error en el reconocimiento de voz:', event.error); stopListening(); }; state.recognition.onend = () => { if(state.isListening) stopListening(); }; }
    function toggleListening() { if (!state.isListening) { startListening(); } else { stopListening(); } }
    function startListening() { try { state.recognition.start(); state.isListening = true; DOM.voiceControlButton.classList.add('listening'); DOM.voiceControlButton.title = "Escuchando... Haz clic para detener."; } catch (e) { console.error("No se pudo iniciar el reconocimiento de voz:", e); } }
    function stopListening() { if (state.recognition) state.recognition.stop(); state.isListening = false; DOM.voiceControlButton.classList.remove('listening'); DOM.voiceControlButton.title = "Control por voz (experimental)"; }
    function handleVoiceResult(event) { const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase(); console.log('Comando reconocido:', command); processVoiceCommand(command); }
    function processVoiceCommand(command) { if (command.includes('iniciar') || command.includes('empezar') || command.includes('continuar')) { if (state.isPaused) toggleTimer(); } else if (command.includes('pausar') || command.includes('parar')) { if (!state.isPaused) pauseTimer(); } else if (command.includes('resetear')) { resetTimer(); } else if (command.includes('trabajo') || command.includes('pomodoro')) { changeMode(CONSTANTS.MODES.POMODORO); } else if (command.includes('descanso corto')) { changeMode(CONSTANTS.MODES.SHORT_BREAK); } else if (command.includes('descanso largo')) { changeMode(CONSTANTS.MODES.LONG_BREAK); } else if (command.startsWith('a√±adir tarea')) { const taskText = command.replace('a√±adir tarea', '').trim(); if (taskText) { addTask(taskText); showToast('Tarea a√±adida', `"${taskText}"`, '‚úÖ'); } } }

    document.addEventListener('DOMContentLoaded', () => {
        initializeFirebase();
        setupAudio();
        setupVoiceRecognition();
        setupAmbientSounds();
        const savedTheme = localStorage.getItem('pomodoroTheme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if ((savedTheme === 'dark') || (!savedTheme && systemPrefersDark)) {
            DOM.rootElement.classList.add('dark');
        }
        updateThemeUI();
        Object.keys(state.durations).forEach(mode => { const savedDuration = localStorage.getItem(`${mode}Duration`); if (savedDuration) state.durations[mode] = parseInt(savedDuration, 10); });
        state.timeLeft = state.durations.pomodoro;
        updateActiveModeButton(state.currentMode);
        updateTimerDisplay();
        loadStats();
        loadGamificationState();
        loadTasks();
        initializeChart();
        updateStatsUI();
        
        document.getElementById('breakdown-task-btn')?.addEventListener('click', handleTaskBreakdown);

        DOM.friendsButton.addEventListener('click', () => { openModal(DOM.friendsModal, generateFriendsModalContent(), () => { renderFriendsContent(); setupFriendsModalListeners(); }); DOM.mainMenu.classList.add('hidden'); });
        DOM.achievementsButton.addEventListener('click', () => { openModal(DOM.achievementsModal, generateAchievementsModalContent()); DOM.mainMenu.classList.add('hidden'); });
        DOM.forestButton.addEventListener('click', () => { openModal(DOM.forestModal, generateForestModalContent()); DOM.mainMenu.classList.add('hidden'); });
        DOM.trajectoryButton.addEventListener('click', () => { 
            openModal(DOM.trajectoryModal, generateTrajectoryModalContent(), () => {
                document.getElementById('generate-summary-btn')?.addEventListener('click', handleGenerateSummary);
            }); 
            DOM.mainMenu.classList.add('hidden'); 
        });
        DOM.shareButton.addEventListener('click', () => { openModal(DOM.shareModal, generateShareModalContent()); DOM.mainMenu.classList.add('hidden'); });
        DOM.notificationsButton.addEventListener('click', requestNotificationPermission);
        DOM.addTaskForm.addEventListener('submit', (e) => { e.preventDefault(); addTask(DOM.taskInput.value); });
        DOM.taskList.addEventListener('click', (e) => {
            const taskItem = e.target.closest('.task-item');
            if (!taskItem) return;
            // If the delete button OR the checkbox is clicked, delete the task.
            if (e.target.closest('.delete-task-btn') || e.target.type === 'checkbox') {
                deleteTask(taskItem.dataset.id);
            } else {
                setActiveTask(taskItem.dataset.id);
            }
        });
        DOM.startPauseButton.addEventListener('click', toggleTimer);
        DOM.resetButton.addEventListener('click', () => changeMode(state.currentMode));
        DOM.timeDisplay.addEventListener('click', enterEditMode);
        DOM.menuButton.addEventListener('click', (e) => { e.stopPropagation(); DOM.mainMenu.classList.toggle('hidden'); });
        DOM.volumeButton.addEventListener('click', (e) => { e.stopPropagation(); DOM.volumeSliderContainer.classList.toggle('hidden'); });
        DOM.volumeSlider.addEventListener('input', (e) => { const newVolume = parseFloat(e.target.value); if(state.audio.volumeNode) state.audio.volumeNode.volume.value = Tone.gainToDb(newVolume); localStorage.setItem('pomodoroVolume', newVolume); });
        DOM.historyButton.addEventListener('click', () => { openModal(DOM.historyModal, generateHistoryModalContent(), () => { const historyTabs = DOM.historyModal.querySelectorAll('.history-tab'); function setActiveTab(period) { historyTabs.forEach(t => t.classList.toggle('active', t.dataset.period === period)); renderHistory(period); } historyTabs.forEach(tab => tab.addEventListener('click', () => setActiveTab(tab.dataset.period))); setActiveTab('weekly'); }); DOM.mainMenu.classList.add('hidden'); });
        DOM.suggestionsButton.addEventListener('click', () => { openModal(DOM.suggestionsModal, suggestionModalContent, setupSuggestionModal); DOM.mainMenu.classList.add('hidden'); });
        DOM.themeButton.addEventListener('click', (e) => { e.stopPropagation(); DOM.colorPalette.classList.toggle('hidden'); });
        DOM.colorPalette.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') applyAccentColor(e.target.dataset.theme); });
        DOM.darkModeToggle.addEventListener('click', toggleDarkMode);
        DOM.modeSelector.addEventListener('click', (e) => { if (e.target.dataset.mode) changeMode(e.target.dataset.mode); });
        document.addEventListener('click', (e) => { if (!DOM.mainMenu.contains(e.target) && !DOM.menuButton.contains(e.target)) DOM.mainMenu.classList.add('hidden'); if (!DOM.colorPalette.contains(e.target) && !DOM.themeButton.contains(e.target)) DOM.colorPalette.classList.add('hidden'); if (!DOM.volumeSliderContainer.contains(e.target) && !DOM.volumeButton.contains(e.target)) DOM.volumeSliderContainer.classList.add('hidden'); });
        window.addEventListener('keydown', (e) => { if (document.activeElement === DOM.taskInput || document.activeElement.id === 'time-input-edit') return; switch(e.code) { case 'Space': e.preventDefault(); toggleTimer(); break; case 'KeyR': changeMode(state.currentMode); break; case 'KeyP': changeMode(CONSTANTS.MODES.POMODORO); break; case 'KeyS': changeMode(CONSTANTS.MODES.SHORT_BREAK); break; case 'KeyL': changeMode(CONSTANTS.MODES.LONG_BREAK); break; } });
    });

</script>
</body>
</html>


